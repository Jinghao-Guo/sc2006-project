{% extends "base.html" %}

{% block title %}Search Results - HDB Search Singapore{% endblock %}

{% block content %}
<div class="search-header mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2><i class="fas fa-search-location text-primary"></i> Search Results</h2>
            <p class="text-muted">
                Found {{ total_count }} flat{{ 's' if total_count != 1 else '' }} total
                {% if query %} for "{{ query }}"{% endif %}
                {% if town %} in {{ town }}{% endif %}
                {% if flat_type %} - {{ flat_type }}{% endif %}
                {% if total_pages > 1 %}
                <br><small>Showing page {{ page }} of {{ total_pages }} ({{ flats|length }} flats on this page)</small>
                {% endif %}
                {% if has_preferences %} 
                <br><small><i class="fas fa-sort-amount-down text-primary"></i> Sorted by compatibility with your preferences</small>
                {% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> New Search
            </a>
        </div>
    </div>
</div>

{% if flats %}
<div class="results-grid">
    {% for flat in flats %}
    <div class="card mb-3 shadow-sm hover-card">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-1">
                        <a href="{{ url_for('flat_detail', flat_id=flat.id) }}" class="text-decoration-none">
                            Block {{ flat.block }}, {{ flat.street_name }}
                        </a>
                    </h5>
                    <p class="text-muted mb-2">{{ flat.town }}</p>
                    
                    <div class="flat-details">
                        <span class="badge bg-primary me-2">{{ flat.flat_type }}</span>
                        <span class="badge bg-info me-2">{{ flat.floor_area_sqm }}m²</span>
                        <span class="badge bg-secondary me-2">{{ flat.storey_range }}</span>
                        {% if flat.remaining_lease %}
                        <span class="badge bg-warning text-dark">{{ flat.remaining_lease }}</span>
                        {% endif %}
                    </div>
                    
                    {% if flat.flat_model %}
                    <p class="text-muted small mt-2 mb-0">
                        <i class="fas fa-building"></i> {{ flat.flat_model }}
                        {% if flat.lease_commence_date %}
                        | Built in {{ flat.lease_commence_date }}
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="price-section">
                        {% if has_preferences and flat.compatibility_score > 0 %}
                        <div class="compatibility-score mb-2">
                            <span class="badge bg-{% if flat.compatibility_score >= 80 %}success{% elif flat.compatibility_score >= 60 %}warning{% elif flat.compatibility_score >= 40 %}info{% else %}secondary{% endif %} fs-6">
                                <i class="fas fa-heart"></i> {{ flat.compatibility_score }}% Match
                            </span>
                        </div>
                        {% endif %}
                        
                        <h4 class="text-success mb-1">
                            ${{ "{:,.0f}".format(flat.resale_price) }}
                        </h4>
                        <p class="text-muted small mb-2">
                            ${{ "{:,.0f}".format(flat.resale_price / flat.floor_area_sqm) }}/m²
                        </p>
                        <a href="{{ url_for('flat_detail', flat_id=flat.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Search results pagination" class="mt-5">
    <ul class="pagination justify-content-center">
        <!-- Previous Button -->
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('search', q=query, town=town, flat_type=flat_type, page=page-1) if page > 1 else '#' }}" 
               aria-label="Previous" {% if page <= 1 %}tabindex="-1"{% endif %}>
                <span aria-hidden="true">&laquo; Previous</span>
            </a>
        </li>

        <!-- First Page -->
        {% if page > 3 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('search', q=query, town=town, flat_type=flat_type, page=1) }}">1</a>
        </li>
        {% if page > 4 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}

        <!-- Page Numbers (show current page and 2 pages before/after) -->
        {% for p in range([1, page - 2]|max, [total_pages, page + 2]|min + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('search', q=query, town=town, flat_type=flat_type, page=p) }}">
                {{ p }}
                {% if p == page %}<span class="sr-only">(current)</span>{% endif %}
            </a>
        </li>
        {% endfor %}

        <!-- Last Page -->
        {% if page < total_pages - 2 %}
        {% if page < total_pages - 3 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('search', q=query, town=town, flat_type=flat_type, page=total_pages) }}">{{ total_pages }}</a>
        </li>
        {% endif %}

        <!-- Next Button -->
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('search', q=query, town=town, flat_type=flat_type, page=page+1) if page < total_pages else '#' }}" 
               aria-label="Next" {% if page >= total_pages %}tabindex="-1"{% endif %}>
                <span aria-hidden="true">Next &raquo;</span>
            </a>
        </li>
    </ul>
</nav>

<!-- Results Summary -->
<div class="text-center text-muted mb-4">
    <small>
        Showing {{ ((page - 1) * per_page) + 1 }} to {{ [page * per_page, total_count]|min }} of {{ total_count }} result{{ 's' if total_count != 1 else '' }}
    </small>
</div>
{% endif %}

{% else %}
<div class="no-results text-center py-5">
    <i class="fas fa-search fa-4x text-muted mb-3"></i>
    <h3 class="text-muted">No HDB flats found</h3>
    <p class="text-muted mb-4">
        {% if query or town or flat_type %}
        Try adjusting your search criteria or 
        {% endif %}
        make sure the database is populated with data.
    </p>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-primary me-2">
            <i class="fas fa-search"></i> Try Another Search
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Add hover effect for cards
document.querySelectorAll('.hover-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '';
    });
});
</script>
{% endblock %}